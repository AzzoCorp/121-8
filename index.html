<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map - Display a map</title>
  <style type="text/css">
    html, body {
      margin: 0px;
      height: 100%;
      width: 100%;
      background: transparent;
    }
    .container {
      width: 100%;
      height: 100%;
      background: transparent;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/maptalks/dist/maptalks.css">
  <script type="text/javascript" src="https://unpkg.com/maptalks/dist/maptalks.min.js"></script>
  <script src="./GeoDatas/depots.js"></script>
  <script src="./GeoDatas/favorables.js"></script>
  <body>
    <div id="map" class="container"></div>
    <script>
      var map = new maptalks.Map('map', {
        center: [9.27970, 41.59099],
        zoom: 10,
        pitch: 45, // Add pitch to view the altitude effect
        layerSwitcherControl: {
          'position'  : 'top-right',
          'baseTitle' : 'Base Layers',
          'overlayTitle' : 'Layers',
          'excludeLayers' : [],
          'containerClass' : 'maptalks-layer-switcher'
        },
        baseLayer: new maptalks.GroupTileLayer('Base TileLayer', [
          new maptalks.TileLayer('Vectorielle', {
            urlTemplate: 'https://{s}.tile.osm.org/{z}/{x}/{y}.png',
            subdomains: ["a", "b", "c"],
          }),
          new maptalks.TileLayer('Claire',{
            'visible' : false,
            'urlTemplate': 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'subdomains'  : ['a','b','c','d']
          }),
          new maptalks.TileLayer('Foncée',{
            'visible' : false,
            'urlTemplate': 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
            'subdomains'  : ['a','b','c','d']
          }),
          new maptalks.TileLayer('Satelite',{
            'visible' : false,
            'urlTemplate': 'http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
            'subdomains':['mt0','mt1','mt2','mt3']
          })
        ])
      });

      changeView();

      function changeView() {
        map.animateTo({
          center: [9.27970, 41.59099],
          zoom: 5,
          pitch: 60,
          bearing: 20
        }, { duration: 5000 });
        setTimeout(function () {
          map.animateTo({
            center: [9.27970, 41.59099],
            zoom: 17,
            pitch: 55,
            bearing: 90
          }, { duration: 5000 });
        }, 5000);
      }

      function extractSquareMeters(text) {
        if (!text) return 0;
        var match = text.match(/Surface plancher créée\s*:\s*([\d,.]+)\s*m²/);
        var squareMeters = match ? parseFloat(match[1].replace(',', '.')) : 0;
        return squareMeters;
      }

      function addGeoJSONLayer(geojson, style, layerName) {
        console.log('Adding GeoJSON Layer:', layerName);
        var geometries = maptalks.GeoJSON.toGeometry(geojson);
        var vectorLayer = new maptalks.VectorLayer(layerName, { enableAltitude: true }).addTo(map);
        var labelLayer = new maptalks.VectorLayer(layerName + '_labels', {
          collision: true // Enable collision detection for the label layer
        }).addTo(map);

        var shadowSymbol = {
          lineColor: '#333332',
          lineDasharray: [10, 5, 5],
          lineWidth: 2,
          polygonFill: '#333332',
          polygonOpacity: 0.4
        };
        var shadows = [];

        geometries.forEach(geometry => {
          var properties = geometry.getProperties();
          console.log('Geometry properties:', properties);
          var depots = properties.depots && properties.depots[0]; // Check if depots and the first item exist
          var areaText = depots ? depots[7] : ''; // Assuming the 8th item is at index 7
          console.log('Area text:', areaText);
          var altitude = extractSquareMeters(areaText) / 100; // Divide by 10 for a more realistic number
          console.log('Calculated altitude:', altitude);

          // Ensure properties include the altitude
          properties.altitude = altitude;
          geometry.setProperties(properties);

          // Verify properties after setting altitude
          console.log('Updated geometry properties:', geometry.getProperties());

          // Set the symbol without altitude
          geometry.setSymbol({
            'lineColor': style.lineColor,
            'lineWidth': style.lineWidth,
            'polygonFill': style.polygonFill,
            'polygonOpacity': style.polygonOpacity
          });

          vectorLayer.addGeometry(geometry);

          // Create shadow geometry
          var shadow = geometry.copy().setSymbol(shadowSymbol);
          shadows.push(shadow);

          var center = geometry.getCenter();
          var label = new maptalks.Label(properties.numero + ' ' + properties.section, center, {
            'textSymbol': {
              'textFaceName': 'monospace',
              'textFill': '#34495e',
              'textHorizontalAlignment': 'center',
              'textVerticalAlignment': 'middle',
              'textWeight': 'bold' // Make the text bold
            }
          });
          labelLayer.addGeometry(label);
        });

        // Add shadows to a new layer and bring it to back
        new maptalks.VectorLayer(layerName + '_shadows', shadows).addTo(map).bringToBack();

        // Add zoomend event listener to control label visibility
        map.on('zoomend', function() {
          var zoom = map.getZoom();
          if (zoom >= 12) {
            labelLayer.show();
          } else {
            labelLayer.hide();
          }
        });

        // Initial visibility check
        if (map.getZoom() < 12) {
          labelLayer.hide();
        }
      }

      // Define styles
      var depotsStyle = {
        'lineColor' : '#030000',
        'lineWidth' : 1,
        'polygonFill' : '#ff00fe',
        'polygonOpacity' : 1
      };

      var favorablesStyle = {
        'lineColor' : '#030000',
        'lineWidth' : 1,
        'polygonFill' : '#009cff',
        'polygonOpacity' : 1
      };

      // Add depots layer
      addGeoJSONLayer(depots, depotsStyle, 'depotsLayer');

      // Add favorables layer
      addGeoJSONLayer(favorables, favorablesStyle, 'favorablesLayer');
    </script>
  </body>
</html>
